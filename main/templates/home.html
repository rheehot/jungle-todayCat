{% extends "main.html" %}
{% block head %}
<style>
    .posting-box {
        display: block;
        width: 250px;
        height: 300px;

        border: 1px solid black;
        border-radius: 5px;

        padding: 25px;
    }
</style>


{% endblock %}


{% block header %}
<div class="wrap">
    <div class="jumbotron">
        <h1 class="display-4">오늘의 고양이</h1>
        <p class="lead"></p>
        <hr class="my-4">
        <p>당신의 고양이를 자랑해주세요!</p>
    </div>
</div>
{% endblock %}

{% block content %}
<script>
    function editCard(id){
            console.log("id:",id)
            let card_src = $('#'+id).data("src");
            let card_desc = $('#'+id).data("desc");

            let temp_html = `
            <div class="card">
                <img class="card-img-top" src="${card_src}">
                <div class="card-body">
                     <input type="file" class="control-file" name="new_attachfile" id="new_attachfile">
                    <input type="text" class="card-text" name="new_desc" id="new_desc" value="${card_desc}">
                    <button class="my-2 btn btn-primary btn-sm" onclick='editCardSave("${id}")'>저장</button>
            </div>
            `
            $('#'+id).html(temp_html);
    }

    function editCardSave(id){
        let new_desc = $('#new_desc').val();
        let new_img = $('#new_attachfile')[0].files;
        console.log("new_img:",$('#new_attachfile')[0])
        var form_data = new FormData();
        if(new_img.length > 0 ){
           form_data.append('new_attachfile',new_img[0]);
           form_data.append('desc', new_desc);
           form_data.append('id', id);
        }
        console.log("desc:",form_data.get('new_attachfile'));

        $.ajax({
            type: 'POST',
            url : '/edit',
            data: form_data,
            contentType: false,
            processData: false,
            success : function(data){
                if(data["data"] == "success"){
                    alert("수정 완료");
                    window.location.reload();
                }
            }
        })
    }

    $(document).ready(function(){
    $(".delete").on('click', function() {  // 클래스값이 delete인 엘리먼트가 눌리면?
        if(confirm("정말로 삭제하시겠습니까?")) {  // 확인 창이 열림
            location.href = $(this).data('uri');  // data-uri 속성값으로 URL 호출
        }
    });
});
</script>

          <div class="card" style="width: 18rem;">
              <form method="post" action="{{url_for('write')}}" enctype="multipart/form-data">
                <input type="file" class="control-file" name="attachfile" id="attachfile">
                <div class="card-body">
                    <input type="text" class="card-text" name="desc" id="desc">
                    <button type="submit" class="btn btn-primary">업로드</button>
                </div>
              </form>
          </div>

{% if results is not none %}
    <div class="card-columns">
        {% for result in results %}
            <div id="{{result._id}}" class="card" data-src="../../images/{{result.attachfile}}" data-desc='{{result.desc}}'>
                <img class="card-img-top" src="../../images/{{result.attachfile}}">
                <div class="card-body">

                    <div class="card-name" data-name="{{result.name}}">{{result.name }}</div>
                    <div class="card-date" data-date="{{result.created}}">{{result.created | format_datetime}}</div>
                    <p class="card-desc">{{result.desc}}</p>
                    <button onclick='editCard("{{result._id}}")' class="btn btn-primary">수정</button>
                    <a href="#" class="delete btn btn-sm btn-outline-secondary"
                   data-uri="{{ url_for('delete', _id = result._id) }}">삭제</a>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}
{% endblock %}
